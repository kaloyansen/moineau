#!/usr/bin/env sh

REAL=`realpath $0`
OU=`dirname $REAL`
ROOTDIR=$OU/..
SRC=$ROOTDIR/src
DATASET=$ROOTDIR/dataset
NEGATIVES=$DATASET/negatives
export POSITIVES=$DATASET/positives
export OUTPUT_CSV=$DATASET/annotations.csv
export OUTPUT_TXT=$DATASET/annotations.txt
export SCALE_FACTOR=3
VECTOR=$POSITIVES.vec
CLASSIFIER=$DATASET/classifier
SERVER_ADDRESS=192.168.0.104

NUM_STAGES=16

quit() {
    deactivate
    fusermount -u $DATASET || echo cannot unmount sshfs
    echo exit code $1
    exit $1 || kill $$
}

sshfs $USER@$SERVER_ADDRESS:$DATASET $DATASET
if [ $? ]; then
    echo sshfs success
else
    echo sshfs failure
    quit 4
fi

pos=`ls $POSITIVES | wc -l` || quit 111
neg=`ls $NEGATIVES | wc -l` || quit 166

echo pos: $pos, neg: $neg
source $ROOTDIR/venv/bin/activate

case $1 in
    create)
	$SRC/csv2txt.py 
	opencv_createsamples -info $OUTPUT_TXT -num $pos -w 24 -h 24 -vec $VECTOR
	;;
    train)
	rm -fv $CLASSIFIER/*.xml
	find $NEGATIVES -type f -name "*.jpg" > $NEGATIVES.txt
	opencv_traincascade -data $CLASSIFIER -vec $VECTOR -bg $NEGATIVES.txt -numPos $pos -numNeg $neg -numStages $NUM_STAGES -w 24 -h 24
	;;
    *)
	$SRC/annotate.py
	;;
esac	
echo ok && quit 0 || kill $$
